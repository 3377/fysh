#!/bin/bash

# 全局变量
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SSH_MANAGER_DIR="$HOME/.ssh_manager"
SSH_DIR="$SSH_MANAGER_DIR"
KEY_NAME="drfykey"
HOSTS_FILE="$SSH_MANAGER_DIR/hosts"
CURRENT_USER="$(whoami)"
CURRENT_HOST="$(hostname)"
TIMESTAMP="$(date +%Y%m%d_%H%M%S)"

# WebDAV配置
WEBDAV_BASE_URL="https://pan.hstz.com"
WEBDAV_PATH="/dav"
WEBDAV_FULL_URL="${WEBDAV_BASE_URL}${WEBDAV_PATH}"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 输出信息
info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

success() {
    echo -e "${BLUE}[SUCCESS]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

# 测试WebDAV连接
test_webdav() {
    local user="$1"
    local pass="$2"
    
    info "测试WebDAV连接..."
    
    # 创建一个临时文件
    local temp_file="test_${TIMESTAMP}.tmp"
    echo "test" > "$temp_file"
    
    # 尝试上传临时文件
    if ! curl -s -f -T "$temp_file" -u "$user:$pass" "$WEBDAV_FULL_URL/$temp_file"; then
        error "无法连接到WebDAV服务器"
        rm -f "$temp_file"
        return 1
    fi
    
    # 检查文件是否存在
    if ! curl -s -f -X PROPFIND --header "Depth: 1" -u "$user:$pass" "$WEBDAV_FULL_URL/$temp_file" >/dev/null 2>&1; then
        error "无法验证WebDAV上传"
        rm -f "$temp_file"
        return 1
    fi
    
    # 删除临时文件
    curl -s -f -X DELETE -u "$user:$pass" "$WEBDAV_FULL_URL/$temp_file"
    rm -f "$temp_file"
    
    info "WebDAV连接测试成功"
    return 0
}

# 初始化配置
init_config() {
    # 确保SSH管理目录存在
    if [ ! -d "$SSH_MANAGER_DIR" ]; then
        mkdir -p "$SSH_MANAGER_DIR"
        chmod 700 "$SSH_MANAGER_DIR"
    fi
    
    # 如果主机列表文件不存在，创建一个空文件
    if [ ! -f "$HOSTS_FILE" ]; then
        touch "$HOSTS_FILE"
        chmod 600 "$HOSTS_FILE"
    fi
    
    # 创建备份目录
    if [ ! -d "$SSH_MANAGER_DIR/backups" ]; then
        mkdir -p "$SSH_MANAGER_DIR/backups"
        chmod 700 "$SSH_MANAGER_DIR/backups"
    fi
}

# 备份文件
backup_file() {
    local file="$1"
    local backup_dir="$SSH_MANAGER_DIR/backups"
    local backup_file="$backup_dir/$(basename "$file").bak.${TIMESTAMP}"
    
    if [ -f "$file" ]; then
        cp "$file" "$backup_file"
        chmod 600 "$backup_file"
    fi
}

# 生成新的SSH密钥对
generate_keys() {
    info "生成新的SSH密钥对..."
    ssh-keygen -t rsa -b 4096 -f "$SSH_DIR/$KEY_NAME" -N "" -C "Generated by SSH Manager for $CURRENT_USER@$CURRENT_HOST"
    chmod 600 "$SSH_DIR/$KEY_NAME"
    chmod 644 "$SSH_DIR/$KEY_NAME.pub"
    
    # 自动将当前主机添加到授权列表
    echo "$CURRENT_USER@$CURRENT_HOST" >> "$HOSTS_FILE"
    chmod 600 "$HOSTS_FILE"
    
    info "SSH密钥对已生成"
    return 0
}

# 下载文件
download_file() {
    local url="$1"
    local output="$2"
    local user="$3"
    local pass="$4"

    # 使用 -L 参数跟随重定向，并检查文件内容
    if ! curl -s -f -L -o "$output" -u "$user:$pass" "$url"; then
        error "下载失败: $url"
        return 1
    fi

    # 验证文件内容
    if grep -q "^<!DOCTYPE\|^<html\|^<a href=" "$output"; then
        error "下载的文件包含HTML内容，可能是重定向页面"
        return 1
    fi

    # 确保文件不为空
    if [ ! -s "$output" ]; then
        error "下载的文件为空"
        return 1
    fi

    return 0
}

# 从WebDAV下载文件
download_from_webdav() {
    local user="$1"
    local pass="$2"
    local temp_dir
    temp_dir=$(mktemp -d)
    
    info "正在从WebDAV下载文件..."
    
    # 下载私钥
    if ! curl -s -f -L -o "${temp_dir}/${KEY_NAME}" -u "$user:$pass" "$WEBDAV_FULL_URL/${KEY_NAME}"; then
        error "私钥下载失败"
        rm -rf "$temp_dir"
        return 1
    fi
    
    # 验证私钥文件
    if grep -q "^<!DOCTYPE\|^<html\|^<a href=" "${temp_dir}/${KEY_NAME}" || [ ! -s "${temp_dir}/${KEY_NAME}" ]; then
        error "私钥文件无效"
        rm -rf "$temp_dir"
        return 1
    fi
    
    # 下载公钥
    if ! curl -s -f -L -o "${temp_dir}/${KEY_NAME}.pub" -u "$user:$pass" "$WEBDAV_FULL_URL/${KEY_NAME}.pub"; then
        error "公钥下载失败"
        rm -rf "$temp_dir"
        return 1
    fi
    
    # 验证公钥文件
    if grep -q "^<!DOCTYPE\|^<html\|^<a href=" "${temp_dir}/${KEY_NAME}.pub" || [ ! -s "${temp_dir}/${KEY_NAME}.pub" ]; then
        error "公钥文件无效"
        rm -rf "$temp_dir"
        return 1
    fi
    
    # 下载主机列表
    if ! curl -s -f -L -o "${temp_dir}/hosts" -u "$user:$pass" "$WEBDAV_FULL_URL/hosts"; then
        warn "主机列表下载失败，将创建新的列表"
        touch "${temp_dir}/hosts"
    else
        # 验证主机列表文件
        if grep -q "^<!DOCTYPE\|^<html\|^<a href=" "${temp_dir}/hosts"; then
            warn "主机列表文件无效，将创建新的列表"
            : > "${temp_dir}/hosts"
        fi
    fi
    
    # 如果本地没有密钥，直接使用下载的密钥
    if [ ! -f "$SSH_DIR/$KEY_NAME" ]; then
        mv "${temp_dir}/${KEY_NAME}" "$SSH_DIR/$KEY_NAME"
        mv "${temp_dir}/${KEY_NAME}.pub" "$SSH_DIR/${KEY_NAME}.pub"
        chmod 600 "$SSH_DIR/$KEY_NAME"
        chmod 644 "$SSH_DIR/${KEY_NAME}.pub"
    fi
    
    # 合并主机列表（增量更新）
    if [ -f "${temp_dir}/hosts" ] && [ -s "${temp_dir}/hosts" ]; then
        # 确保本地hosts文件存在
        touch "$HOSTS_FILE"
        # 合并远程主机列表到本地，去除重复项
        cat "${temp_dir}/hosts" "$HOSTS_FILE" | grep -v "^<!DOCTYPE\|^<html\|^<a href=" | sort | uniq > "${temp_dir}/hosts_merged"
        mv "${temp_dir}/hosts_merged" "$HOSTS_FILE"
        chmod 600 "$HOSTS_FILE"
    fi
    
    rm -rf "$temp_dir"
    return 0
}

# 上传文件到WebDAV
upload_to_webdav() {
    local user="$1"
    local pass="$2"
    local temp_dir
    temp_dir=$(mktemp -d)
    
    info "准备上传文件到WebDAV..."
    
    # 先下载现有的主机列表
    if curl -s -f -L -X PROPFIND --header "Depth: 1" -u "$user:$pass" "$WEBDAV_FULL_URL/hosts" >/dev/null 2>&1; then
        info "发现现有主机列表，正在合并..."
        if ! curl -s -f -L -o "${temp_dir}/hosts" -u "$user:$pass" "$WEBDAV_FULL_URL/hosts"; then
            warn "无法下载现有主机列表，将创建新的列表"
            cp "$HOSTS_FILE" "${temp_dir}/hosts"
        else
            # 验证下载的主机列表
            if grep -q "^<!DOCTYPE\|^<html\|^<a href=" "${temp_dir}/hosts"; then
                warn "下载的主机列表无效，将创建新的列表"
                cp "$HOSTS_FILE" "${temp_dir}/hosts"
            else
                # 合并主机列表（增量更新）
                cat "$HOSTS_FILE" "${temp_dir}/hosts" | sort | uniq > "${temp_dir}/hosts_merged"
                mv "${temp_dir}/hosts_merged" "${temp_dir}/hosts"
            fi
        fi
    else
        cp "$HOSTS_FILE" "${temp_dir}/hosts"
    fi
    
    # 上传合并后的主机列表
    if ! curl -s -f -T "${temp_dir}/hosts" -u "$user:$pass" "$WEBDAV_FULL_URL/hosts"; then
        error "主机列表上传失败"
        rm -rf "$temp_dir"
        return 1
    fi
    
    # 如果远程没有密钥文件，则上传本地的密钥
    if ! curl -s -f -X PROPFIND --header "Depth: 1" -u "$user:$pass" "$WEBDAV_FULL_URL/${KEY_NAME}" >/dev/null 2>&1; then
        info "未发现远程密钥，上传本地密钥..."
        # 上传私钥
        if ! curl -s -f -T "$SSH_DIR/$KEY_NAME" -u "$user:$pass" "$WEBDAV_FULL_URL/${KEY_NAME}"; then
            error "私钥上传失败"
            rm -rf "$temp_dir"
            return 1
        fi
        
        # 上传公钥
        if ! curl -s -f -T "$SSH_DIR/${KEY_NAME}.pub" -u "$user:$pass" "$WEBDAV_FULL_URL/${KEY_NAME}.pub"; then
            error "公钥上传失败"
            rm -rf "$temp_dir"
            return 1
        fi
    fi
    
    rm -rf "$temp_dir"
    success "文件上传完成"
    return 0
}

# 授权当前主机
authorize_current_host() {
    local pub_key
    pub_key=$(cat "$SSH_DIR/${KEY_NAME}.pub")
    if ! grep -q "$pub_key" "$HOSTS_FILE"; then
        echo "$pub_key" >> "$HOSTS_FILE"
        success "已授权当前主机: $CURRENT_HOST"
    else
        warn "当前主机已经被授权"
    fi
}

# 批量授权主机
batch_authorize_hosts() {
    local hosts_file="$1"
    if [ ! -f "$hosts_file" ]; then
        error "主机列表文件不存在: $hosts_file"
        return 1
    fi

    while IFS= read -r host; do
        if [ -n "$host" ]; then
            if ! grep -q "$host" "$HOSTS_FILE"; then
                echo "$host" >> "$HOSTS_FILE"
                success "已授权主机: $host"
            else
                warn "主机已经被授权: $host"
            fi
        fi
    done < "$hosts_file"
}

# 显示授权主机列表
list_hosts() {
    echo
    info "授权主机列表："
    if [ -f "$HOSTS_FILE" ]; then
        if [ -s "$HOSTS_FILE" ]; then
            # 显示主机列表，每行前面加上 "- "
            while IFS= read -r line; do
                echo "  - $line"
            done < "$HOSTS_FILE"
        else
            echo "  (空)"
        fi
    else
        echo "  (空)"
        touch "$HOSTS_FILE"
        chmod 600 "$HOSTS_FILE"
    fi
}

# 显示菜单
show_menu() {
    echo -e "\n${BLUE}=== SSH Manager 菜单 ===${NC}"
    echo "1) 查看授权主机列表"
    echo "2) 授权当前主机"
    echo "3) 批量授权主机"
    echo "4) 同步到WebDAV"
    echo "5) 从WebDAV同步"
    echo "6) 退出"
    echo -e "${YELLOW}请选择操作 [1-6]:${NC} "
}

# 处理菜单选择
handle_menu() {
    local choice
    while true; do
        show_menu
        read -r choice
        case $choice in
            1)
                list_hosts
                ;;
            2)
                authorize_current_host
                ;;
            3)
                echo -e "${YELLOW}请输入主机列表文件路径:${NC} "
                read -r hosts_file
                batch_authorize_hosts "$hosts_file"
                ;;
            4)
                if upload_to_webdav "$WEBDAV_USER" "$WEBDAV_PASS"; then
                    success "文件已成功上传到WebDAV"
                fi
                ;;
            5)
                if download_from_webdav "$WEBDAV_USER" "$WEBDAV_PASS"; then
                    success "文件已成功从WebDAV下载"
                fi
                ;;
            6)
                success "感谢使用！"
                exit 0
                ;;
            *)
                warn "无效的选择，请重试"
                ;;
        esac
    done
}

# 显示帮助信息
show_help() {
    echo "SSH Key Manager - 帮助信息"
    echo "用法: $0 <用户名> <密码>"
    echo
    echo "功能:"
    echo "- 生成SSH密钥对"
    echo "- WebDAV同步"
    echo "- 批量部署公钥"
    echo "- 主机连接测试"
    echo "- 授权主机管理"
}

# 主程序
main() {
    # 检查参数
    if [ $# -eq 2 ]; then
        WEBDAV_USER="$1"
        WEBDAV_PASS="$2"
        
        # 初始化配置
        init_config
        
        # 测试WebDAV连接
        if ! test_webdav "$WEBDAV_USER" "$WEBDAV_PASS"; then
            exit 1
        fi
        
        # 检查是否需要初始化密钥
        if [ ! -f "$SSH_DIR/$KEY_NAME" ]; then
            # 检查WebDAV上是否有现有配置
            info "检查WebDAV上的配置..."
            if curl -s -f -L -X PROPFIND --header "Depth: 1" -u "$WEBDAV_USER:$WEBDAV_PASS" "$WEBDAV_FULL_URL/${KEY_NAME}" >/dev/null 2>&1; then
                info "发现现有配置，正在下载..."
                if ! download_from_webdav "$WEBDAV_USER" "$WEBDAV_PASS"; then
                    error "配置下载失败"
                    exit 1
                fi
                success "已从WebDAV下载配置"
            else
                info "未找到现有配置，开始初始化..."
                generate_keys
            fi
        fi
        
        # 自动授权当前主机
        authorize_current_host
        
        # 同步到WebDAV（增量更新）
        if ! upload_to_webdav "$WEBDAV_USER" "$WEBDAV_PASS"; then
            error "同步到WebDAV失败"
            exit 1
        fi
        success "初始配置完成"
        
        # 显示交互式菜单
        handle_menu
    else
        show_help
        exit 1
    fi
}

main "$@"
